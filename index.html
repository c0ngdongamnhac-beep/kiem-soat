<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Construction Admin Excel Pro</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #28a745; --danger: #dc3545; --bg: #f8f9fa; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--bg); padding-bottom: 70px; }
        .app-header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 100; }
        .tab-bar { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 48px; z-index: 99; }
        .tab-item { flex: 1; padding: 15px; text-align: center; font-weight: bold; color: #666; cursor: pointer; }
        .tab-item.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .container { padding: 15px; max-width: 500px; margin: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; font-weight: bold; color: #666; margin-bottom: 4px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .btn-add { background: var(--success); color: white; margin-bottom: 10px; }
        .btn-excel { background: #107c41; color: white; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .data-card { background: white; border-radius: 10px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .data-card.done { border-left-color: #ccc; opacity: 0.5; }
        .actions { display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between; }
        .check-circle { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .check-circle.checked { background: var(--primary); color: white; border-color: var(--primary); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-num { display: block; font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="app-header">KI·ªÇM SO√ÅT THI C√îNG</div>

<div class="tab-bar">
    <div class="tab-item active" onclick="switchTab('nhaplieu')">NH·∫¨P LI·ªÜU</div>
    <div class="tab-item" onclick="switchTab('thongke')">TH·ªêNG K√ä</div>
</div>

<div class="container">
    <div id="nhaplieu" class="page active">
        <div class="card">
            <label>H·ªå V√Ä T√äN</label>
            <input type="text" id="name" placeholder="T√™n c√¥ng nh√¢n..." autocomplete="off">
            <label>ƒê∆†N V·ªä</label>
            <input type="text" id="unit" placeholder="C√¥ng ty / T·ªï ƒë·ªôi...">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1"><label>S·ªê TH·∫∫</label><input type="text" id="cardId" placeholder="M√£ th·∫ª..."></div>
                <div style="flex:1"><label>TR·∫†NG TH√ÅI</label><select id="status"><option value="V√ÄO">V√ÄO</option><option value="RA">RA</option></select></div>
            </div>
            <label>V·ªä TR√ç</label>
            <input type="text" id="position" placeholder="T·∫ßng, khu v·ª±c...">
            <button class="btn btn-add" onclick="addData()">GHI D·ªÆ LI·ªÜU</button>
            <button class="btn btn-excel" onclick="exportToExcel()">XU·∫§T FILE EXCEL (.XLSX)</button>
        </div>
        <div id="dataList"></div>
    </div>

    <div id="thongke" class="page">
        <div class="stat-grid">
            <div class="stat-box"><span class="stat-num" id="stat-total">0</span><span class="stat-label">T·ªïng l∆∞·ª£t</span></div>
            <div class="stat-box"><span class="stat-num" id="stat-present" style="color: var(--success);">0</span><span class="stat-label">ƒêang ·ªü l·∫°i</span></div>
        </div>
        <div class="card">
            <h4 style="margin: 0 0 10px 0">Qu√¢n s·ªë theo ƒê∆°n v·ªã</h4>
            <table id="unitTable">
                <thead><tr><th>ƒê∆°n v·ªã</th><th>S·ªë ng∆∞·ªùi</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn" style="background:#6c757d; color:white; font-size:0.8rem" onclick="safeClearAll()">L√†m m·ªõi d·ªØ li·ªáu (1234)</button>
    </div>
</div>

<script>
    function switchTab(tabId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        if(tabId === 'thongke') updateStats();
    }

    function addData() {
        const n = document.getElementById('name'), u = document.getElementById('unit'), c = document.getElementById('cardId'), p = document.getElementById('position'), s = document.getElementById('status');
        if (!n.value.trim() || !c.value.trim()) return alert("Thi·∫øu t√™n ho·∫∑c th·∫ª!");

        const entry = {
            ID: Date.now(),
            "Th·ªùi Gian": new Date().toLocaleString('vi-VN'),
            "H·ªç T√™n": n.value.trim(),
            "ƒê∆°n V·ªã": u.value.trim() || "N/A",
            "S·ªë Th·∫ª": c.value.trim(),
            "V·ªã Tr√≠": p.value.trim() || "N/A",
            "Tr·∫°ng Th√°i": s.value,
            isDone: false
        };

        let list = JSON.parse(localStorage.getItem('constructionData')) || [];
        list.unshift(entry);
        localStorage.setItem('constructionData', JSON.stringify(list));

        n.value = ''; c.value = ''; u.value = ''; p.value = '';
        n.focus();
        displayData();
    }

    function displayData() {
        const list = JSON.parse(localStorage.getItem('constructionData')) || [];
        const container = document.getElementById('dataList');
        container.innerHTML = list.map(item => `
            <div class="data-card ${item.isDone ? 'done' : ''}">
                <div>
                    <span style="font-weight:bold">${item["H·ªç T√™n"]}</span><br>
                    <small>${item["ƒê∆°n V·ªã"]} | Th·∫ª: ${item["S·ªë Th·∫ª"]}</small><br>
                    <small>TT: <b>${item["Tr·∫°ng Th√°i"]}</b></small>
                </div>
                <div class="actions">
                    <button style="background:none; border:none; color:red" onclick="deleteRow(${item.ID})">üóëÔ∏è</button>
                    <div class="check-circle ${item.isDone ? 'checked' : ''}" onclick="toggleDone(${item.ID})">${item.isDone ? '‚úì' : ''}</div>
                </div>
            </div>
        `).join('');
    }

    function deleteRow(id) {
        if(confirm("X√≥a d√≤ng n√†y?")) {
            let list = JSON.parse(localStorage.getItem('constructionData')) || [];
            localStorage.setItem('constructionData', JSON.stringify(list.filter(i => i.ID !== id)));
            displayData();
        }
    }

    function toggleDone(id) {
        let list = JSON.parse(localStorage.getItem('constructionData')) || [];
        const idx = list.findIndex(i => i.ID === id);
        list[idx].isDone = !list[idx].isDone;
        localStorage.setItem('constructionData', JSON.stringify(list));
        displayData();
    }

    function updateStats() {
        const list = JSON.parse(localStorage.getItem('constructionData')) || [];
        document.getElementById('stat-total').innerText = list.length;
        document.getElementById('stat-present').innerText = list.filter(i => !i.isDone).length;
        const units = {};
        list.forEach(i => units[i["ƒê∆°n V·ªã"]] = (units[i["ƒê∆°n V·ªã"]] || 0) + 1);
        const tbody = document.querySelector('#unitTable tbody');
        tbody.innerHTML = Object.keys(units).map(u => `<tr><td>${u}</td><td>${units[u]}</td></tr>`).join('');
    }

    // H√ÄM XU·∫§T EXCEL QUAN TR·ªåNG
    function exportToExcel() {
        const list = JSON.parse(localStorage.getItem('constructionData')) || [];
        if (list.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");

        // Chu·∫©n b·ªã d·ªØ li·ªáu: Lo·∫°i b·ªè c√°c tr∆∞·ªùng k·ªπ thu·∫≠t nh∆∞ ID v√† isDone tr∆∞·ªõc khi xu·∫•t
        const cleanData = list.map(({ID, isDone, ...rest}) => rest);

        // T·∫°o Worksheet t·ª´ d·ªØ li·ªáu
        const worksheet = XLSX.utils.json_to_sheet(cleanData);
        // T·∫°o Workbook
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "B√°o c√°o");

        // Xu·∫•t file
        const fileName = `BaoCao_KS_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`;
        XLSX.writeFile(workbook, fileName);
    }

    function safeClearAll() {
        if (prompt("Nh·∫≠p '1234' ƒë·ªÉ x√≥a:") === "1234") {
            localStorage.removeItem('constructionData');
            displayData();
            updateStats();
        }
    }

    window.onload = displayData;
</script>
</body>
</html>
